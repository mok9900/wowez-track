<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ë¬¸ì ë¡œê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, onSnapshot, collectionGroup, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

        // Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹…ìš©)
        setLogLevel('Debug');

        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
        let app;
        let auth;
        let db;
        let userId = 'unknown'; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID (UID)
        let isManager = false; // ê´€ë¦¬ì ì—¬ë¶€ í”Œë˜ê·¸
        let use12HourFormat = true; // ì‹œê°„ í‘œì‹œ í˜•ì‹ (ê¸°ë³¸ê°’: 12ì‹œê°„/AM/PM)
        let currentLogs = []; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë¡œê·¸ ë°ì´í„° ë°°ì—´

        // Firebase êµ¬ì„± ê°ì²´ (ì‚¬ìš©ì ì œê³µ ì •ë³´ë¡œ ëŒ€ì²´)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyB1ApaFJIQWlS6dj9SGiviHyCMwlvD1mcY",
            authDomain: "track-ez-9ecb7.firebaseapp.com",
            projectId: "track-ez-9ecb7",
            storageBucket: "track-ez-9ecb7.firebasestorage.app",
            messagingSenderId: "893851585207",
            appId: "1:893851585207:web:ba248d9bcab0d793361b32",
            measurementId: "G-E69E7TLNZN"
        };
        
        // ê´€ë¦¬ì ê¶Œí•œì„ ê°€ì§ˆ ì´ë©”ì¼ ëª©ë¡
        const AUTHORIZED_USERS = [
            "menda_427@naver.com",
            "gs25q0818@gmail.com",
            "gs25q0327@gmail.com"
        ];

        // UI ìš”ì†Œ
        const statusDiv = document.getElementById('auth-status');
        const loginButton = document.getElementById('google-login-btn');
        const logoutButton = document.getElementById('google-logout-btn');
        const adminDashboard = document.getElementById('admin-dashboard');
        const logTableBody = document.getElementById('log-table-body');
        const totalLogsSpan = document.getElementById('total-logs');
        const timeToggleContainer = document.getElementById('time-format-toggle-container');
        
        // ì»¤ìŠ¤í…€ ëª¨ë‹¬
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        let currentDeleteParams = null; // {docId, logUserUid}


        // Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const initFirebase = () => {
            try {
                // Firebase ì´ˆê¸°í™” (ì‚¬ìš©ì ì •ì˜ ì„¤ì • ì‚¬ìš©)
                app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);

                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        const userEmail = user.email;
                        
                        isManager = AUTHORIZED_USERS.includes(userEmail);
                        
                        updateUI(userEmail, isManager);

                        if (isManager) {
                            fetchLogs();
                        } else {
                            console.warn(`[ì ‘ê·¼ ê±°ë¶€] ë¹„ì¸ê°€ëœ ê´€ë¦¬ì ì ‘ê·¼ ì‹œë„: ${userEmail}`);
                        }
                    } else {
                        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                        userId = 'unknown';
                        isManager = false;
                        updateUI(null, false);
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                statusDiv.innerHTML = `<p class="text-red-500 font-bold">â›” Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}</p>`;
                loginButton.disabled = true;
            }
        };

        // Google ë¡œê·¸ì¸ íŒì—… í•¸ë“¤ëŸ¬
        const handleGoogleSignIn = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google íŒì—… ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                let errorMessage = `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                statusDiv.innerHTML = `<p class="text-red-400 font-bold mt-4 p-3 bg-gray-700 rounded-lg">${errorMessage}</p>`;
            }
        };
        
        // UI ìƒíƒœ ì—…ë°ì´íŠ¸
        const updateUI = (email, isManager) => {
            loginButton.classList.add('hidden');
            logoutButton.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            timeToggleContainer.classList.add('hidden');
            statusDiv.classList.remove('hidden');

            if (isManager) {
                statusDiv.innerHTML = `<p class="text-indigo-400 font-semibold">âœ… ë¡œê·¸ì¸ ì„±ê³µ. ê´€ë¦¬ì(${email})</p>`;
                adminDashboard.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                timeToggleContainer.classList.remove('hidden');
            } else if (email) {
                statusDiv.innerHTML = `<p class="text-red-500 font-bold">â›” ì ‘ê·¼ ê±°ë¶€ë¨. ê³„ì •: ${email}. ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                logoutButton.classList.remove('hidden');
            } else {
                statusDiv.innerHTML = `<p class="text-gray-400">ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.</p>`;
                loginButton.classList.remove('hidden');
            }
        };

        // ë¡œê·¸ë¥¼ í…Œì´ë¸”ì— ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        const renderLogs = (logs) => {
            logTableBody.innerHTML = ''; 
            totalLogsSpan.textContent = logs.length.toString();
            
            if (logs.length === 0) {
                 logTableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-gray-500">ì¡°íšŒëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                 return;
            }

            logs.forEach(log => {
                const dateOptions = { 
                    year: 'numeric', month: 'numeric', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: use12HourFormat 
                };
                
                // Firestore Timestamp ê°ì²´ë¥¼ Date ê°ì²´ë¡œ ë³€í™˜
                const timeStr = log.timestamp.toDate().toLocaleString('ko-KR', dateOptions);

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700 transition duration-150';
                
                const truncateText = (text, maxLength = 20) => text.length > maxLength ? text.substring(0, maxLength) + '...' : text;

                row.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300 font-mono">${timeStr}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-indigo-400 truncate max-w-xs" title="${log.userId}">${truncateText(log.userId, 15)}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300">${log.ipAddress}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300">${log.country || 'N/A'}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300">${log.isp || 'N/A'}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-400 truncate max-w-xs" title="${log.userAgent}">${truncateText(log.userAgent, 30)}</td>
                    <td class="p-4 whitespace-nowrap text-right">
                        <button 
                            class="delete-log-btn text-red-400 hover:text-red-500 font-medium transition duration-150 p-2 rounded-lg bg-gray-700 hover:bg-red-900/50"
                            data-doc-id="${log.id}"
                            data-user-uid="${log.userUid}"
                            onclick="handleDeleteClick(event)"
                        >
                            ì‚­ì œ
                        </button>
                    </td>
                `;
                logTableBody.appendChild(row);
            });
            currentLogs = logs; 
        };

        // ì‹¤ì‹œê°„ ë¡œê·¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (onSnapshot)
        const fetchLogs = () => {
            if (!db || !auth.currentUser) {
                totalLogsSpan.textContent = 'N/A'; // ì¸ì¦ì´ ì•ˆë˜ë©´ N/A
                return;
            }
            
            const logsCollectionGroup = collectionGroup(db, "visitor_logs");
            
            const q = query(
                logsCollectionGroup, 
                orderBy('timestamp', 'desc'), 
                limit(100) 
            ); 

            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    const pathParts = doc.ref.path.split('/');
                    const appIdFromDb = pathParts[1];
                    const userUidFromDb = pathParts[3];
                    
                    logs.push({ 
                        id: doc.id, 
                        appId: appIdFromDb, 
                        userUid: userUidFromDb, 
                        ...data 
                    });
                });
                
                renderLogs(logs); 
            }, (error) => {
                console.error("ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜ (ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥ì„±):", error);
                
                // Firestore ë³´ì•ˆ ê·œì¹™ ì˜¤ë¥˜ (Permission Denied)ê°€ ë°œìƒí–ˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
                totalLogsSpan.textContent = 'N/A';
                
                let errorMessage = `<p class="text-red-500 font-bold mt-4">âš ï¸ ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}.</p>`;
                
                if (error.code === 'permission-denied') {
                     errorMessage = `<p class="text-red-500 font-bold mt-4">ğŸ›‘ Firestore ê¶Œí•œ ì˜¤ë¥˜: ê´€ë¦¬ìê°€ <span class="text-yellow-400">Firebase ê·œì¹™</span>ì„ ìˆ˜ì •í•˜ì—¬ ëª¨ë“  ì‚¬ìš©ìì˜ ë¡œê·¸ë¥¼ <span class="text-yellow-400">ì½ì„ ìˆ˜ ìˆë„ë¡</span> í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
                } else if (error.code === 'failed-precondition' && error.message.includes('query requires an index')) {
                    errorMessage = `<p class="text-red-500 font-bold mt-4">âš ï¸ Firestore ìƒ‰ì¸ ì˜¤ë¥˜: <span class="text-yellow-400">ê°œë°œì ì½˜ì†”(F12)ì— í‘œì‹œë˜ëŠ” ìƒ‰ì¸ ìƒì„± ë§í¬</span>ë¥¼ í´ë¦­í•˜ì—¬ ìƒ‰ì¸ì„ ìƒì„±í•´ ì£¼ì„¸ìš”. (ì´ë¯¸ ì™„ë£Œëœ ìƒíƒœì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>`;
                }
                
                statusDiv.innerHTML = errorMessage;
            });
        };
        
        // ë¡œê·¸ ì‚­ì œ 
        const deleteLog = async (docId, logUserUid) => {
            if (!db || !auth.currentUser) return;
            
            // ì‚­ì œë¥¼ ìœ„í•œ AppIdëŠ” Firebase í”„ë¡œì íŠ¸ IDë¡œ ê³ ì •í•©ë‹ˆë‹¤.
            const logAppId = FIREBASE_CONFIG.projectId; 
            
            // ì •í™•í•œ ë¬¸ì„œ ê²½ë¡œ: artifacts/{appId}/users/{userUid}/visitor_logs/{docId}
            const docRef = doc(db, `artifacts/${logAppId}/users/${logUserUid}/visitor_logs`, docId);
            
            try {
                const btn = document.querySelector(`[data-doc-id="${docId}"]`);
                if(btn) {
                    btn.textContent = 'ì‚­ì œ ì¤‘...';
                    btn.disabled = true;
                }

                await deleteDoc(docRef);
                console.log("ë¬¸ì„œ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë¨:", docRef.path);
            } catch (error) {
                console.error("ë¡œê·¸ ì‚­ì œ ì˜¤ë¥˜:", error);
                statusDiv.innerHTML = `<p class="text-red-500 font-bold mt-4">ì‚­ì œ ì‹¤íŒ¨: ${error.message}. ê²½ë¡œ: ${docRef.path}</p>`;
            }
        };

        // ì „ì—­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleGoogleSignOut = () => signOut(auth);
        
        // -- ì»¤ìŠ¤í…€ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ --
        const showModal = (message, params) => {
            modalMessage.textContent = message;
            currentDeleteParams = params;
            confirmationModal.classList.remove('hidden');
        };

        const hideModal = () => {
            confirmationModal.classList.add('hidden');
            currentDeleteParams = null;
        };

        const handleConfirmDelete = () => {
            if (currentDeleteParams) {
                deleteLog(currentDeleteParams.docId, currentDeleteParams.logUserUid);
            }
            hideModal();
        };

        // ë¡œê·¸ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ íŠ¸ë¦¬ê±°
        window.handleDeleteClick = (event) => {
            const btn = event.currentTarget;
            const params = {
                docId: btn.getAttribute('data-doc-id'),
                logUserUid: btn.getAttribute('data-user-uid')
            };

            showModal("ì •ë§ë¡œ ì´ ë¡œê·¸ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", params);
        };

        // ì‹œê°„ í˜•ì‹ í† ê¸€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        window.handleTimeToggleChange = (event) => {
            use12HourFormat = event.target.checked;
            renderLogs(currentLogs); // ì‹œê°„ í˜•ì‹ë§Œ ë³€ê²½í•˜ì—¬ í…Œì´ë¸” ì¬ë Œë”ë§
        };
        
        // Make modal handlers available globally for inline onclick
        window.hideModal = hideModal;
        window.handleConfirmDelete = handleConfirmDelete;

        // ì´ˆê¸°í™” ì‹œì‘
        initFirebase();
    </script>
    <style>
        /* í°íŠ¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ë””ìì¸ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4B5563; /* Gray-600 */
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4F46E5; /* Indigo-600 */
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-indigo-500/50 pb-4 mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-400 tracking-wider">ë°©ë¬¸ì ë¡œê·¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <div class="mt-4 sm:mt-0 flex items-center space-x-3">
                
                <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì¸ì¦ ì‹œ í‘œì‹œ) -->
                <button 
                    id="google-logout-btn" 
                    onclick="handleGoogleSignOut()" 
                    class="hidden px-4 py-2 text-sm font-semibold bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-lg transition duration-150"
                >
                    ë¡œê·¸ì•„ì›ƒ
                </button>
                
                <!-- ì‹œê°„ í˜•ì‹ í† ê¸€ (ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œ í‘œì‹œ) -->
                <div id="time-format-toggle-container" class="hidden flex items-center space-x-3">
                    <span class="text-xs font-medium text-gray-400">24ì‹œê°„</span>
                    <label class="toggle-switch">
                        <input id="time-format-toggle" type="checkbox" checked onchange="handleTimeToggleChange(event)">
                        <span class="slider"></span>
                    </label>
                    <span class="text-xs font-medium text-indigo-400">AM/PM</span>
                </div>
            </div>
        </header>

        <!-- ì¸ì¦ ìƒíƒœ ë° ë¡œê·¸ì¸ ë²„íŠ¼ -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-800 p-6 rounded-xl shadow-2xl mb-6">
            <div id="auth-status" class="text-lg text-gray-400">
                ë¡œê·¸ì¸ ì¤‘...
            </div>
            <button 
                id="google-login-btn" 
                onclick="handleGoogleSignIn()" 
                class="mt-4 sm:mt-0 px-6 py-3 text-lg font-bold bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-xl transition duration-300 transform hover:scale-[1.02] active:scale-[0.98]"
            >
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
        </div>
        
        <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì˜ì—­ -->
        <div id="admin-dashboard" class="hidden">
            <h2 class="text-2xl font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2">ë°©ë¬¸ì ê¸°ë¡</h2>
            
            <div class="text-gray-400 mb-4">
                ì´ <span id="total-logs" class="text-indigo-400 font-bold">0</span>ê°œ ê¸°ë¡
            </div>

            <!-- ë¡œê·¸ í…Œì´ë¸” -->
            <div class="overflow-x-auto bg-gray-800 rounded-xl shadow-2xl">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">ì‹œê°„</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">ì‚¬ìš©ì ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">IP ì£¼ì†Œ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">êµ­ê°€</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ISP</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/6">ë¸Œë¼ìš°ì €/ê¸°ê¸° ì •ë³´</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body" class="divide-y divide-gray-700/50">
                        <!-- ë¡œê·¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center text-gray-500 text-sm">
                ìµœëŒ€ 100ê°œ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-11/12 max-w-md transform transition-all duration-300">
            <h3 class="text-xl font-bold text-red-400 mb-4">ê¸°ë¡ ì‚­ì œ í™•ì¸</h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button 
                    onclick="hideModal()" 
                    class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-600 hover:bg-gray-700 rounded-lg transition duration-150"
                >
                    ì·¨ì†Œ
                </button>
                <button 
                    id="confirm-delete-btn"
                    onclick="handleConfirmDelete()"
                    class="px-4 py-2 text-sm font-medium bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150"
                >
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

</body>
</html>
