<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방문자 로그 관리 시스템</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, onSnapshot, collection, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

        // Firestore 로그 레벨 설정 (디버깅용)
        setLogLevel('Debug');

        // Firebase 구성 객체 (사용자 제공 정보)
        // 이 구성은 실제 서비스와 연결됩니다.
        const firebaseConfig = {
            apiKey: "AIzaSyB1ApaFJIQWlS6dj9SGiviHyCMwlvD1mcY",
            authDomain: "track-ez-9ecb7.firebaseapp.com",
            projectId: "track-ez-9ecb7",
            storageBucket: "track-ez-9ecb7.firebasestorage.app",
            messagingSenderId: "893851585207",
            appId: "1:893851585207:web:ba248d9bcab0d793361b32",
            measurementId: "G-E69E7TLNZN"
        };

        // 관리자 권한을 가질 이메일 목록
        // 여기에 로그인한 Google 계정 이메일이 포함되어야만 관리자 대시보드에 접근 가능합니다.
        const AUTHORIZED_USERS = [
            "menda_427@naver.com",
            "gs25q0818@gmail.com",
            "gs25q0327@gmail.com"
        ];

        let app;
        let auth;
        let db;
        let userId = 'unknown'; // 현재 로그인한 사용자 ID (UID)
        let isManager = false; // 관리자 여부 플래그
        let use12HourFormat = true; // 시간 표시 형식 (기본값: 12시간/AM/PM)
        let currentLogs = []; // 현재 표시 중인 로그 데이터 배열

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // UI 요소
        const statusDiv = document.getElementById('auth-status');
        const loginButton = document.getElementById('google-login-btn');
        const logoutButton = document.getElementById('google-logout-btn');
        const adminDashboard = document.getElementById('admin-dashboard');
        const logTableBody = document.getElementById('log-table-body');
        const totalLogsSpan = document.getElementById('total-logs');
        const timeToggleContainer = document.getElementById('time-format-toggle-container');
        const timeToggleInput = document.getElementById('time-format-toggle');
        
        // -- 커스텀 모달 관련 변수 --
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        let currentDeleteParams = null; // {docId, logAppId, logUserUid}


        // Firebase 초기화 및 인증 리스너 설정
        const initFirebase = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 인증 상태 변경 리스너
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        const userEmail = user.email;
                        
                        isManager = AUTHORIZED_USERS.includes(userEmail);
                        
                        // 관리자 UI 업데이트
                        updateUI(userEmail, isManager);

                        if (isManager) {
                            fetchLogs();
                        } else {
                            // 비인가된 사용자는 접근 거부 로그 기록
                            logIntruder(userEmail);
                        }
                    } else {
                        // 로그아웃 상태
                        userId = 'unknown';
                        isManager = false;
                        updateUI(null, false);
                    }
                });

            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                statusDiv.innerHTML = `<p class="text-red-500 font-bold">⛔ Firebase 초기화 오류: ${error.message}</p>`;
                loginButton.disabled = true;
                loginButton.textContent = "초기화 실패";
            }
        };

        // Google 로그인 팝업 핸들러
        const handleGoogleSignIn = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google 팝업 로그인 오류:", error);
                // auth/unauthorized-domain 오류 시 사용자에게 조치 안내
                let errorMessage = `로그인 실패: ${error.message}`;
                if (error.code === 'auth/unauthorized-domain') {
                    errorMessage += `. 도메인 인증 오류입니다. Firebase 콘솔의 Authentication > Settings > Authorized domains에 현재 페이지 도메인(${window.location.host})을 추가하세요.`;
                }
                statusDiv.innerHTML = `<p class="text-red-400 font-bold mt-4 p-3 bg-gray-700 rounded-lg">${errorMessage}</p>`;
            }
        };
        
        // 비인가 사용자 침입 로그 기록 (기능 구현을 위해 임시로 비활성화)
        const logIntruder = (email) => {
            console.log(`[침입 감지] ${email} - 비인가된 관리자 접근 시도`);
            // Firestore 규칙에 의해 관리자만 기록 가능하도록 설정되어 있다면 이 함수는 실행되지 않습니다.
        };

        // UI 상태 업데이트
        const updateUI = (email, isManager) => {
            loginButton.classList.add('hidden');
            logoutButton.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            timeToggleContainer.classList.add('hidden');
            statusDiv.classList.remove('hidden');

            if (isManager) {
                // 관리자 로그인 성공
                statusDiv.innerHTML = `<p class="text-indigo-400 font-semibold">✅ 로그인 성공. 관리자(${email})</p>`;
                adminDashboard.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                timeToggleContainer.classList.remove('hidden');
            } else if (email) {
                // 일반 사용자 (비인가 관리자) 로그인
                statusDiv.innerHTML = `<p class="text-red-500 font-bold">⛔ 접근 거부됨. 계정: ${email}. 이 계정은 관리자가 아닙니다.</p>`;
                logoutButton.classList.remove('hidden');
            } else {
                // 로그아웃 상태 또는 초기 상태
                statusDiv.innerHTML = `<p class="text-gray-400">로그인되지 않은 사용자입니다.</p>`;
                loginButton.classList.remove('hidden');
            }
        };

        // 로그를 테이블에 렌더링하는 함수
        const renderLogs = (logs) => {
            logTableBody.innerHTML = ''; // 테이블 초기화
            totalLogsSpan.textContent = logs.length;
            
            logs.forEach(log => {
                // 시간 형식 포맷터 설정
                const dateOptions = { 
                    year: 'numeric', month: 'numeric', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: use12HourFormat 
                };
                
                const timeStr = log.timestamp.toDate().toLocaleString('ko-KR', dateOptions);

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700 transition duration-150';
                
                // 긴 문자열은 truncate하고 툴팁(title) 제공
                const truncateText = (text, maxLength = 20) => text.length > maxLength ? text.substring(0, maxLength) + '...' : text;

                row.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300 font-mono">${timeStr}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-indigo-400 truncate max-w-xs" title="${log.userId}">${truncateText(log.userId, 15)}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300">${log.ipAddress}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300">${log.country || 'N/A'}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-300">${log.isp || 'N/A'}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-400 truncate max-w-xs" title="${log.userAgent}">${truncateText(log.userAgent, 30)}</td>
                    <td class="p-4 whitespace-nowrap text-right">
                        <button 
                            class="delete-log-btn text-red-400 hover:text-red-500 font-medium transition duration-150 p-2 rounded-lg bg-gray-700 hover:bg-red-900/50"
                            data-doc-id="${log.id}"
                            data-app-id="${log.appId}"
                            data-user-uid="${log.userUid}"
                            onclick="handleDeleteClick(event)"
                        >
                            삭제
                        </button>
                    </td>
                `;
                logTableBody.appendChild(row);
            });
            currentLogs = logs; // 현재 로그 데이터 업데이트
        };

        // 실시간 로그 데이터 가져오기 (onSnapshot)
        const fetchLogs = () => {
            if (!db || !auth.currentUser) return;
            
            // 모든 사용자의 로그를 조회하기 위한 컬렉션 그룹 쿼리 (Firestore 규칙 필수)
            const logsCollectionGroup = collection(db, "visitor_logs");
            const q = query(logsCollectionGroup, limit(100)); // 최신 100개만 가져오기

            // onSnapshot 리스너를 통해 실시간 업데이트 처리
            onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // 문서 경로에서 실제 userUid와 appId 추출
                    const pathParts = doc.ref.path.split('/');
                    const userUidFromDb = pathParts[3]; // /artifacts/{appId}/users/{userUid}/visitor_logs/{docId}
                    const appIdFromDb = pathParts[1];
                    
                    logs.push({ 
                        id: doc.id, 
                        appId: appIdFromDb,
                        userUid: userUidFromDb,
                        ...data 
                    });
                });
                
                // 최신 순으로 정렬 (Timestamp 필드가 있다고 가정)
                logs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                
                renderLogs(logs); // UI 렌더링
            }, (error) => {
                console.error("로그 불러오기 오류:", error);
                
                // Firestore Collection Group Index 누락 오류에 대한 안내
                let errorMessage = `<p class="text-red-500 font-bold mt-4">로그 불러오기 오류 발생. <span class="text-yellow-400">개발자 콘솔(F12)을 확인</span>하여 <span class="text-yellow-400">Firestore 색인 생성 링크</span>를 클릭해 주세요.</p>`;
                statusDiv.innerHTML = errorMessage;
            });
        };
        
        // 로그 삭제 (사용자 UID와 App ID를 포함한 정확한 경로 지정)
        const deleteLog = async (docId, logAppId, logUserUid) => {
            if (!db || !auth.currentUser) return;
            
            // 정확한 문서 경로: /artifacts/{appId}/users/{userUid}/visitor_logs/{docId}
            const docRef = doc(db, `artifacts/${logAppId}/users/${logUserUid}/visitor_logs`, docId);
            
            try {
                // 삭제 요청 시 UI 임시 업데이트
                const btn = document.querySelector(`[data-doc-id="${docId}"]`);
                const originalText = btn.textContent;
                btn.textContent = '삭제 중...';
                btn.disabled = true;

                await deleteDoc(docRef);
                console.log("문서 성공적으로 삭제됨:", docRef.path);
                
                // Firestore 리스너(onSnapshot)가 자동으로 테이블을 업데이트할 것입니다.
            } catch (error) {
                console.error("로그 삭제 오류:", error);
                // 모달/alert 대신 콘솔에 오류 기록 및 상태 표시
                statusDiv.innerHTML = `<p class="text-red-500 font-bold mt-4">삭제 실패: ${error.message}. 콘솔을 확인하세요.</p>`;
            }
        };

        // 전역 이벤트 핸들러 등록
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleGoogleSignOut = () => signOut(auth);
        
        // -- 커스텀 모달 관련 함수 --
        const showModal = (message, params) => {
            modalMessage.textContent = message;
            currentDeleteParams = params;
            confirmationModal.classList.remove('hidden');
        };

        const hideModal = () => {
            confirmationModal.classList.add('hidden');
            currentDeleteParams = null;
        };

        const handleConfirmDelete = () => {
            if (currentDeleteParams) {
                deleteLog(currentDeleteParams.docId, currentDeleteParams.logAppId, currentDeleteParams.logUserUid);
            }
            hideModal();
        };

        // 로그 삭제 확인 모달 트리거
        window.handleDeleteClick = (event) => {
            const btn = event.currentTarget;
            const params = {
                docId: btn.getAttribute('data-doc-id'),
                logAppId: btn.getAttribute('data-app-id'),
                logUserUid: btn.getAttribute('data-user-uid')
            };

            showModal("정말로 이 로그 기록을 삭제하시겠습니까?", params);
        };

        // 시간 형식 토글 이벤트 핸들러
        window.handleTimeToggleChange = (event) => {
            use12HourFormat = event.target.checked;
            renderLogs(currentLogs); // 시간 형식만 변경하여 테이블 재렌더링
        };
        
        // Make modal handlers available globally for inline onclick
        window.hideModal = hideModal;
        window.handleConfirmDelete = handleConfirmDelete;

        // 초기화 시작
        initFirebase();
    </script>
    <style>
        /* 폰트 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* 토글 스위치 디자인 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4B5563; /* Gray-600 */
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4F46E5; /* Indigo-600 */
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-indigo-500/50 pb-4 mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-400 tracking-wider">방문자 로그 관리 시스템</h1>
            <div class="mt-4 sm:mt-0 flex items-center space-x-3">
                
                <!-- 로그아웃 버튼 (인증 시 표시) -->
                <button 
                    id="google-logout-btn" 
                    onclick="handleGoogleSignOut()" 
                    class="hidden px-4 py-2 text-sm font-semibold bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-lg transition duration-150"
                >
                    로그아웃
                </button>
                
                <!-- 시간 형식 토글 (관리자 로그인 시 표시) -->
                <div id="time-format-toggle-container" class="hidden flex items-center space-x-3">
                    <span class="text-xs font-medium text-gray-400">24시간</span>
                    <label class="toggle-switch">
                        <input id="time-format-toggle" type="checkbox" checked onchange="handleTimeToggleChange(event)">
                        <span class="slider"></span>
                    </label>
                    <span class="text-xs font-medium text-indigo-400">AM/PM</span>
                </div>
            </div>
        </header>

        <!-- 인증 상태 및 로그인 버튼 -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-800 p-6 rounded-xl shadow-2xl mb-6">
            <div id="auth-status" class="text-lg text-gray-400">
                로그인 중...
            </div>
            <button 
                id="google-login-btn" 
                onclick="handleGoogleSignIn()" 
                class="mt-4 sm:mt-0 px-6 py-3 text-lg font-bold bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-xl transition duration-300 transform hover:scale-[1.02] active:scale-[0.98]"
            >
                Google 계정으로 로그인
            </button>
        </div>
        
        <!-- 관리자 대시보드 영역 -->
        <div id="admin-dashboard" class="hidden">
            <h2 class="text-2xl font-bold text-gray-200 mb-4 border-b border-gray-700 pb-2">방문자 기록</h2>
            
            <div class="text-gray-400 mb-4">
                총 <span id="total-logs" class="text-indigo-400 font-bold">0</span>개 기록
            </div>

            <!-- 로그 테이블 -->
            <div class="overflow-x-auto bg-gray-800 rounded-xl shadow-2xl">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">시간</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">사용자 ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">IP 주소</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">국가</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">ISP</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-2/6">브라우저/기기 정보</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider w-1/12">삭제</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body" class="divide-y divide-gray-700/50">
                        <!-- 로그 데이터가 여기에 로드됩니다 -->
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-center text-gray-500 text-sm">
                최대 100개 기록이 표시됩니다.
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-11/12 max-w-md transform transition-all duration-300">
            <h3 class="text-xl font-bold text-red-400 mb-4">기록 삭제 확인</h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button 
                    onclick="hideModal()" 
                    class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-600 hover:bg-gray-700 rounded-lg transition duration-150"
                >
                    취소
                </button>
                <button 
                    id="confirm-delete-btn"
                    onclick="handleConfirmDelete()"
                    class="px-4 py-2 text-sm font-medium bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150"
                >
                    삭제
                </button>
            </div>
        </div>
    </div>

</body>
</html>
